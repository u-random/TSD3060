<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="utf-8">
    <title>Main form page</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body onload="doInit()" style="text-align: center">
<div style="display: flex; justify-content: space-between; align-items: center;">
    <h1>Main Form Page</h1>
    <div id="loginstatus" style="text-align: right; margin: 20px;">You are not logged in</div>
</div>

    <!--LOGIN.-->
    <h2>Login box</h2>
    <form id="loginForm">
        <label for="email">Username:</label><br>
        <input type="text" id="email" name="email"><br>
        <label for="password">Password:</label><br>
        <input type="password" id="password" name="password"><br>
        <input type="submit" value="Login">
    </form>
    <!--Log out-->
    <hr>
    <h2>Logout box</h2>
    <form id="logoutForm">
        <input type="submit" value="Logout">
    </form>

    <!--Get dikt, one or all.-->
    <hr>
    <h2>Get Dikts</h2>
    <p>Type ID number. Leave empty to get all dikts</p>
    <form id="get">
        <label for="getDiktID">DiktID:</label><br>
        <input type="text" id="getDiktID" name="diktID"><br>
        <input type="submit" value="Get dikts">
    </form>

    <!--ADD dikt.-->
    <hr>
    <h2>Add Dikts here</h2>
    <form id="add">
        <label for="title">Title:</label><br>
        <input type="text" id="title" name="title"><br>
        <input type="submit" value="ADD new dikt">
    </form>
    <!--Edit dikt.-->
    <hr>
    <h2>Edit Dikts here</h2>
    <p>Supply dikt id and new title</p>
    <form id="edit">
        <label for="editDiktID">Dikt ID:</label><br>
        <input type="text" id="editDiktID" name="diktID"><br>
        <label for="editTitle">Title:</label><br>
        <input type="text" id="editTitle" name="title"><br>
        <input type="submit" value="Edit dikt">
    </form>
    <!--DELETE dikt, one or all.-->
    <hr>
    <h2>Delete Dikts here</h2>
    <p>Only diktID needed. No warning provided.</p>
    <form id="delete">
        <label for="deleteDiktID">Dikt ID:</label><br>
        <input type="text" id="deleteDiktID" name="diktID"><br>
        <input type="submit" value="Delete dikt">
    </form>
    <hr>
    <h2>Surprise</h2>
    <a href="surprise.asis">Surprise NOW!</a>
    <hr>
    <h2>Homepage</h2>
    <a href="index.html">Go home</a>
<!--        <script src="web-application.js"></script>-->

<script type="application/ecmascript">

    // Map of form IDs to their respective XML construction functions
    const xmlConstructors = {
        'loginForm': constructLoginXML,
        'edit': constructEditDiktXML,
        'add': constructAddDiktXML
        // Add more form-specific XML constructors here
    };

    function doFormAction(formId, urlPath, method) {
        document.getElementById(formId).addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent form from submitting to server
            let formData = new FormData(this);

            let xmlData = null;
            if (xmlConstructors[formId]) {
                xmlData = xmlConstructors[formId](formData);
            }
            sendRestRequest(xmlData, urlPath, method);
        });
    }

    // Login action
    doFormAction('loginForm', 'login', 'POST');

    // Logout action
    doFormAction('logoutForm', 'logout', 'POST');

    // Add Dikt action
    doFormAction('add', 'dikt', 'POST');

    // For actions dependent on the ID of the Dikt
    function urlManipulationAction(formId, method) {
        const diktId = document.getElementById(formId + 'DiktID').value;
        let path = `dikt/${diktId}`;
        doFormAction(formId, path, method);
    }

    // Set up actions Form:Method

    // Get Dikt action
    urlManipulationAction('get', 'GET');
    // Edit Dikt action
    urlManipulationAction('edit', 'PUT');
    // Delete Dikt action
    urlManipulationAction('delete', 'DELETE');

    function constructLoginXML(formData) {
        let email = formData.get('email');
        let password = formData.get('password');
        return `<login><email>${email}</email><password>${password}</password></login>`;
    }

    function constructEditDiktXML(formData) {
        let title = formData.get('title');
        return `<title>${title}</title>`;
    }

    function constructAddDiktXML(formData) {
        let title = formData.get('title');
        return `<title>${title}</title>`;
    }



    function sendRestRequest(xmlData, urlPath, method) {
        const baseUrl = 'http://192.168.10.200:8280/';
        const options = {
            method: method,
            headers: {
                'Content-Type': 'text/xml; charset=UTF-8'
            }
        };

        if (xmlData && method.toUpperCase() !== 'GET') {
            options.body = xmlData;
        }

        fetch(baseUrl + urlPath, options)
            .then(response => {

                if (response.ok) {
                    // TODO: Get session_id cookie from response and store it in a variable
                    return response.text();
                } else {
                    throw new Error('Network response was not ok.');
                }
            })
            .then(data => {
                domParser = new DOMParser();
                xmlDoc = domParser.parseFromString(data, "text/xml");

                alert(xmlDoc.documentElement.textContent);
            })
            .catch(error => {
                console.error('Errormessage:', error);
            });
    }

    function doInit() {
        setLoginStatus()
    }

    function setLoginStatus() {
        var status = "Not logged in"
        if (getCookie("session_id")) {
            status="You are logged in"
        }
        document.getElementById('loginstatus').textContent = status
    }
</script>
</body>
</html>

